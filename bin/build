#!/usr/bin/env bash
# -*- mode: bash; tab-width: 2; -*-
# vim: ts=2 sw=2 ft=bash noet

# $1 = payload JSON

# exit if anything fails
set -e

payload=$1

# source the common helper functions from NOS
. /opt/nos/common.sh

# initialize NOS
nos_init "$@"

# set our PATH to our node_modules/.bin
export PATH=$(nos_payload 'code_dir')/node_modules/.bin:/data/sbin:/data/bin:$PATH

# the build commands will need to be within the code_dir
cd $(nos_payload 'code_dir')

# gulp rel
nos_run_subprocess "generate release" "gulp rel"

# rel
nos_print_bullet "Copying release into live code directory..."
rsync -a $(nos_payload 'code_dir')/rel/ $(nos_payload 'live_dir')
